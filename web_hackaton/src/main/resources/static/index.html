<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flat disign chat</title>
    <link rel="stylesheet" type="text/css" href="style.css">

</head>
<body>

<div class="body">

    <div id="loginForm" class="loginBox">
        <div class="loginLogs">
            <div class="header">
                <div class="formHeader">
                    <p class="headerText">Login Form:</p>
                </div>
                <input id="name" name="name" value="" style="font-size:medium" type="text"><br>
                <input id="pwd" name="password" value="" style="font-size:medium" type="password"><br>
                <button class="sendbutton" style="font-size:large" onclick="login()">Login</button>
                <br>
                <button class="sendbutton" style="font-size:large" onclick="openRegister()">Register</button>
                <br>
            </div>
        </div>
    </div>

    <div id="registerForm" class="loginBox" style="display: none">
        <div class="loginLogs">
            <div class="header">
                <div class="formHeader">
                    <p class="headerText">Register Form:</p>
                </div>
                <input id="newName" name="name" value="" style="font-size:medium" type="text"><br>
                <input id="pass" name="password" value="" style="font-size:medium" type="password"><br>
                <input id="applyPass" name="passCopy" value="" style="font-size:medium" type="password"><br>
                <button class="sendbutton" style="font-size:large" onclick="register()">Register</button>
                <br>
                <button class="sendbutton" style="font-size:large" onclick="closeRegister(null, null)">Login</button>
                <br>
            </div>
        </div>
    </div>

    <div id="onlineForm" class="loginBox" style="display: none">
        <div class="loginLogs">
            <div class="header">
                <div class="formHeader">
                    <p class="headerText">Loggined User:</p>
                </div>
                <div class="userNameHeader">
                    <p id="userLogin"></p>
                </div>
                <button class="sendbutton" style="font-size:large" onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <div class="chatBox">
        <div id="mesList" class="chatLogs">

            <div id="history" class="chat form">

            </div>

        </div>

        <div class="chatForm">
            <input id="msgform" name="msg" class="msginput" value="" style="font-size:medium" type="text">
            <button class="sendbutton" onclick="say()">Send</button>
        </div>
    </div>

    <div class="userBox">
        <div class="userLogs">
            <div id="users" class="users form"></div>
        </div>
    </div>
</div>
</body>
</html>

<!--
We are using SockJS lib
https://github.com/sockjs/sockjs-client
-->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script>
    var host = "localhost";
    var port = 8080;

    //string contains "name=" used in get/post http services
    var curUserName     = null;
    //string contains "password=" used in get/post http services
    var curUserPassword = null;

    var host = 'localhost';
    var port = 8080;
    var path = 'events';
    var sock;
    var messageList = [];
    var userList = [];

    initSock();

    function initSock() {
        sock = new SockJS('http://' + host + ':' + port + '/' + path);
        sock.onopen = function() {
            console.log('open');
            console.log(sock.id);
        };

        sock.onmessage = function (e) {
            var response = JSON.parse(e.data);
            console.log(response);
            handleResponse(response);
        }

        sock.onclose = function () {
            if (curUserName != null)
                logout();
            console.log('close');
        }
    }

    function handleResponse(response) {
        data = JSON.parse(response.data);
        switch (response.topic) {
            case 'MESSAGE':
                switch (data.topic) {
                    case 'ERROR':
                        alert(ERROR + " " + data.data);
                        console.log(ERROR + " " + data.data);
                        break;
                    case 'OK':
                        document.getElementById('msgform').value= "";
                        break;
                    default:
                        alert("Unexpected message response topic, please call the developers");
                        break;
                }
                break;

            case 'NEW_MESSAGE':
                var htmlMessage = buildMessage(data);
                messageList.push(data);
                $("#history").append(htmlMessage);
                break;
            case 'NEW_USER':
                var htmlNewUser = buildUser(data);
                userList.push(data);
                $("#users").append(htmlNewUser);
                break;
            default:
                alert("Unexpected topic - " + response.topic + ", please call the developers");
                break;
        }
    }

    function rebuildHistory() {
        var newHistory = "";
        messageList.forEach(
            function (message) {
                newHistory = newHistory + buildMessage(message);
            }
        )
        $("#history").html(newHistory.replace(/\n/g, "<br />"));
    }

    function buildMessage(message) {
        var name;
        if ( curUserName == null )
            name = "";
        else
            name = curUserName.substr(5);
        var isCurUser = (name === message.sender);
        var builtMessage =  "<div class=\"chatMessage " + (isCurUser ? "me" : "notMe") + "\">" +
                            "   <div class=\"timeAndPhoto\">" +
                            "       <div class=\"userPhoto\">" +
                            "           <img src=\"img/user" + (isCurUser ? "2" : "1") + ".png\">" +
                            "       </div>" +
                            "       <div class=\"time\">" +
                            message.time +
                            "       </div>" +
                            "   </div>" +
                            "   <div class=\"userLetter\">" +
                            "       <p class=\"userName\">" +
                            (isCurUser ? ":You" : message.sender + ":") +
                            "       </p>" +
                            "       <p class=\"messageBody\">" +
                            message.msg +
                            "       </p>" +
                            "   </div>" +
                            "</div>"
        return builtMessage;
    }

    function rebuildUsers() {
        var outgoingUsers = "";
        userList.forEach(
            function (user) {
                outgoingUsers = outgoingUsers + buildUser(user);
            }
        )
        $("#users").html(outgoingUsers.replace(/\n/g, "<br />"));
    }

    function buildUser(user) {
        var name;
        if ( curUserName == null )
            name = "";
        else
            name = curUserName.substr(5);
        var isCurUser = (name === user.sender);
        var builtUser =  user.sender + "<br>";
        return builtUser;
    }

    openRegister();

    function openRegister() {
        curUserName = null;
        curUserPassword = null;
        document.getElementById('registerForm').style.display = "";
        document.getElementById('loginForm').style.display = "none";
        document.getElementById('onlineForm').style.display = "none";
    }

    function closeRegister(userName, userPassword) {
        document.getElementById('registerForm').style.display = "none";
        changeUser(userName, userPassword);
    }

    function changeUser(userName, userPassword) {
        document.getElementById('registerForm').style.display = "none";
        curUserName = userName;
        curUserPassword = userPassword;
        if (userName == null) {
            document.getElementById('loginForm').style.display = "";
            document.getElementById('onlineForm').style.display = "none";
        }
        else {
            document.getElementById('loginForm').style.display = "none";
            document.getElementById('onlineForm').style.display = "";
            document.getElementById('userLogin').innerHTML = userName.substr(5);
        }
        rebuildHistory();
        rebuildUsers();
    }

    // now this is web functions

    function loadHistory() {
        var name;
        if ( curUserName == null )
            name = "name=";
        else
            name = curUserName;

        var settings = {
            "crossDomain": true,
            "url": "http://" + host + ":" + port + "/chat/chat",
            "method": "GET"
        }

        $.ajax(settings).done(function (response) {
            var prevMessages = [];
            if (messageList.length > 0) {
                prevMessages = messageList
            }

            messageList = JSON.parse(response);
            prevMessages.forEach(
                function (message) {
                    messageList.push(message);
                }
            )
            rebuildHistory();
            $("#history").scrollTop($("#history")[0].scrollHeight);
        }).fail(function (jqXHR, textStatus) {
            console.log(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
        });
    }

    function loadUsers() {
        var settings = {
            "crossDomain": true,
            "url": "http://" + host + ":" + port + "/chat/users",
            "method": "GET",
        }

        $.ajax(settings).done(function (response) {
            userList = JSON.parse(response);
            rebuildUsers();
            $("#users").scrollTop($("#users")[0].scrollHeight);
        }).fail(function (jqXHR, textStatus) {
            console.log(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
        });
    }

    function say() {
        if(curUserName == null)
            return;
        var msg = decodeURI($('#msgform').serialize());
        alert(msg);
        alert(decodeURI(msg));
        var name = curUserName;
        var password = curUserPassword;

        var msgData = JSON.stringify(
        {
            "topic": "MESSAGE",
            "data": {
                "sender": name.substr(5),
                "msg": msg.substr(4),
                "password": password.substr(9)
            }
        });
        sock.send(msgData);
    }

    function login() {
        var name = decodeURI($('#name').serialize());
        var password = decodeURI($('#pwd').serialize());
        var settings = {
            "method": "POST",
            "crossDomain": true,
            "url": "http://" + host + ":" + port + "/chat/login",
            "data": name + "&" + password
        };

        $.ajax(settings).done(function (response) {
            document.getElementById('name').value= "";
            document.getElementById('pwd').value= "";
            changeUser(name, password);
        }).fail(function (jqXHR, textStatus) {
            alert(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
            console.log(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
        });
    }

    function register() {
        var name = decodeURI($('#newName').serialize());
        var password = decodeURI($('#pass').serialize());
        var passAgain = decodeURI($('#applyPass').serialize());
        var settings = {
            "method": "POST",
            "crossDomain": true,
            "url": "http://" + host + ":" + port + "/chat/register",
            "data": name + "&" + password + "&" + passAgain
        };

        $.ajax(settings).done(function (response) {
            document.getElementById('newName').value= "";
            document.getElementById('pass').value= "";
            document.getElementById('applyPass').value= "";
            changeUser(name, password);
        }).fail(function (jqXHR, textStatus) {
            alert(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
            console.log(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
        });
    }

    function logout() {
        var name = curUserName;
        var settings = {
            "method": "POST",
            "crossDomain": true,
            "url": "http://" + host + ":" + port + "/chat/logout",
            "data": name + "&" + curUserPassword
        };

        $.ajax(settings).done(function (response) {
            changeUser(null, null);
        }).fail(function (jqXHR, textStatus) {
            alert(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
            console.log(jqXHR.status + " " + jqXHR.statusText + ". " + jqXHR.responseText);
        });
    }

    loadHistory();
    loadUsers();


</script>